{% extends "base.html" %}
{% block titleBlock %}
Ketan: Real Time Bus Departure !!
{% endblock %}

{% block headBlock %}
<script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
<script src="http://maps.googleapis.com/maps/api/js"></script>
<script src="http://maps.googleapis.com/maps/api/js"></script>
<script>

// Ref: http://www.w3schools.com/html/html5_geolocation.asp
// Default Location
var lat1 = 37.7694699;
var lon1 = -122.42941;
var map;

function show_busstops(lat1, lon1, r, map) {
    //alert('lat: ' + lat1 + 'lon: ' + lon1 + 'r: ' + r) 
    data = {'lat' : lat1, 'lon' : lon1, 'r' : r };
    $.ajax({ 
        type: 'GET', 
        url: '/show_nearest_busstops',
        data: {'lat' : lat1, 'lon' : lon1, 'r' : r },
        success: function (result) {
            display_string = 'Nearest stops: within ' + r + ' km from location(lat=' + lat1 + ', lon=' +lon1 + '):</br>';
            $("#stop_display").append(display_string);
            //$("#stop_display").append('Nearest stops'); //from location(lat='+lat1+'lon='+lon+'):</br>');
            var bus_loc;
            var marker2;
            if (result.length == 0) {
                $("#stop_display").append('No stop found within ' + r + ' kilometer!');
            }
            for (var i = result.length - 1; i >= 0; i--) {
                var stop_info = 'stop_tag: ' + result[i][0][0]+ ' title: '+ result[i][0][1] + ' lat: '+ result[i][0][2] + ' lon: '+ result[i][0][3]+' stop_Id: '+ result[i][0][4] + '</br> ';
                var infowindow_content = 'tag: ' + result[i][0][0]+ ' \ntitle: '+ result[i][0][1];
                var infowindow_title = 'tag: '+result[i][0][0];
                $("#stop_display").append('<b>'+infowindow_content+'</b></br>');
                
                for (var j = result[i][1].length - 1; j >= 0; j--) {
                    var stop_details = 'Agency: ' +result[i][1][j][2] + ' Route: ' + result[i][1][j][1] + ' Direction: ' + result[i][1][j][0];
                    $("#stop_display").append(stop_details + '</br>');
                }
                    
                bus_loc = new google.maps.LatLng(result[i][0][2], result[i][0][3]);
                marker2=new google.maps.Marker({
                        position:bus_loc,
                        //map:map
                        //{% load staticfiles %}
                        //icon:'{% static "DepartureTimesApp/busstop.png" %}',
                        title:infowindow_title
                });
                marker2.setMap(map);
                
                var infowindow = new google.maps.InfoWindow({
                    content:infowindow_content
                    //title:infowindow_title
                });
                //marker2.addListener('click', function() {
                    //infowindow.open(map,marker2);
                //}
            };
            
        }
    });
}

function initialize() {
    var loc = new google.maps.LatLng(0, 0);

    var mapProp = {
        zoom: 17,
        center: loc,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    map = new google.maps.Map(document.getElementById('googleMap'), mapProp);
    lat1 = Number({{ lat }});
    lon1 = Number({{ lon }});
    alert('initial from url: '+lat1+':'+lon1);
    if (!(lat1==0 && lon1==0)) {
        alert('if :'+lat1+':'+lon1);
        loc = new google.maps.LatLng(lat1, lon1);
        map.setCenter(loc);        
        var marker=new google.maps.Marker({
            position:loc,
        });
        marker.setMap(map);
        var circle = new google.maps.Circle({
            center:loc,
            radius:200,
            strokeColor:"#0000FF",
            strokeOpacity:0.8,
            strokeWeight:2,
            fillColor:"#0000FF",
            fillOpacity:0.4
        });

        circle.setMap(map);
        show_busstops(lat1, lon1, 0.2, map);
    }
    else {
        alert('navigating...'+lat1+':'+lon1);
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                lat1 = position.coords.latitude;
                lon1 = position.coords.longitude;
                alert('found: '+lat1+':'+lon1);
                myLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                map.setCenter(myLocation);
             
                var marker=new google.maps.Marker({
                    position:myLocation,
                });
                marker.setMap(map);
                var circle = new google.maps.Circle({
                    center:myLocation,
                    radius:200,
                    strokeColor:"#0000FF",
                    strokeOpacity:0.8,
                    strokeWeight:2,
                    fillColor:"#0000FF",
                    fillOpacity:0.4
                });

                circle.setMap(map);
                show_busstops(lat1, lon1, 0.2, map);       
            });
            //alert(lat1+':'+lon1);
        }
        else {
            alert('navigation failed:'+lat1+':'+lon1);
        }
    }
    //show_busstops(lat1, lon1, 0.2, map);
}

function initialize_test() {
    var loc = new google.maps.LatLng(lat1, lon1);

    var mapProp = {
        zoom: 18,
        center: loc,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    map = new google.maps.Map(document.getElementById('googleMap'), mapProp);

    var marker=new google.maps.Marker({
        position:loc,
    });
    marker.setMap(map);

    show_busstops(lat1, lon1, 0.2, map);
}
google.maps.event.addDomListener(window, 'load', initialize);
</script>

{% endblock %}

{% block content %}
{% comment %}
<ul>
</ul>
<br/><br/>
{% endcomment %}
Go back to <a href="/">homepage</a> to get prediction for route/direction/stop combination
</br>
<div id="googleMap" style="width:700px;height:580px;"></div>
<p id="prediction"></p>
<p id="stop_display"></p>
</br>
{% endblock %}
