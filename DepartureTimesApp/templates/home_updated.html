{% extends "base.html" %}
{% block titleBlock %}
Real Time Bus Departure Homepage!!
{% endblock %}

{% block headBlock %}
<script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
<script src="http://maps.googleapis.com/maps/api/js"></script>

<script>
    $(document).ready(function(){
        $( window ).load(function() {
            $.ajax({ 
                type: 'GET', 
                url: '/show_routes',
                data: {},
                success: function (result) {
                    console.log(result);
                    $("#route_list option").remove();
                    for (var key in result) {
                        $("#route_list").append('<option value="' + key + '">' + result[key] + '</option>');
                    };
                }
            });
        });
        $('select#route_list').change(function () {
            var optionSelected = $(this).find("option:selected");
            var valueSelected  = optionSelected.val();
            var route_tag   = optionSelected.text();

            console.log('route_list select... console');
            console.log(valueSelected);
            $.ajax({ 
                type: 'GET', 
                url: '/show_directions',
                data: {'RT' : valueSelected },
                success: function (result) {
                    console.log(result);
                    $("#direction_list option").remove();
                    for (var key in result) {
                        $("#direction_list").append('<option value="' + key + '">' + result[key] + '</option>');
                    };
                }
            });
        });

        $('select#direction_list').change(function () {
            var optionSelected = $(this).find("option:selected");
            var valueSelected  = optionSelected.val();
            var direction_tag   = optionSelected.text();

            var routeOptionSelected = $('select#route_list').find("option:selected");
            var routeValueSelected  = routeOptionSelected.val();

            console.log('direction_list select... console');
            console.log(valueSelected);
            $.ajax({ 
                type: 'GET', 
                url: '/show_stops',
                data: {'RT' : routeValueSelected, 'DT' : valueSelected },
                success: function (result) {
                    console.log(result);
                    $("#stop_list option").remove();
                    //for (var i = result.length - 1; i >= 0; i--) {
                    for (var key in result) {
                        $("#stop_list").append('<option value="' + key + '">' + result[key] + '</option>');
                        //$("#stop_list").append('<option>'+ result[i] +'</option>');
                    };
                }
            });
        });

        $('select#stop_list').change(function () {
            var optionSelected = $(this).find("option:selected");
            var valueSelected  = optionSelected.val();
            var stop_tag   = optionSelected.text();

            var routeOptionSelected = $('select#route_list').find("option:selected");
            var routeValueSelected  = routeOptionSelected.val();

            var directionOptionSelected = $('select#direction_list').find("option:selected");
            var directionValueSelected  = directionOptionSelected.val();

            console.log('stop_list select... console');
            console.log(stop_tag);
            $.ajax({ 
                type: 'GET', 
                url: '/show_predictions',
                data: {'RT' : routeValueSelected, 'DT' : directionValueSelected, 'ST' :  valueSelected},
                success: function (result) {
                    console.log(result);
                    //$("#prediction").remove();
                    $("#prediction").empty();
                    if (result.length == 0) {
                        $("#prediction").append('Prediction time not available for selected route at this time!');
                    }
                    else {
                        $("#prediction").append('Predicted time for vehicles arriving:');
                        for (var i = 0; i<= result.length -1; i++) {
                           $("#prediction").append(result[i]+' minutes, ');
                        };
                    };
                }
            });
        });
    });
</script>

<script>

// Ref: http://www.w3schools.com/html/html5_geolocation.asp
// Default Location
var lat = 37.7694699;
var lng = -122.42941;

function initialize() {
   var loc = new google.maps.LatLng(lat, lng);

   var mapProp = {
        zoom: 15,
        center: loc,
        mapTypeId: google.maps.MapTypeId.ROADMAP
   };
   var map = new google.maps.Map(document.getElementById('googleMap'), mapProp);

   if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
            myLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
            map.setCenter(myLocation);
             
            var marker=new google.maps.Marker({
                position:myLocation,
            });
            marker.setMap(map);
             
            var bus_loc = new google.maps.LatLng(lat+0.1, lng+0.1);
            var marker2=new google.maps.Marker({
                position:bus_loc,
                {% load staticfiles %}
                icon:'{% static "DepartureTimesApp/busstop.png" %}'
            });

            marker2.setMap(map);

        });
    }
}

function initialize_OLD() {
  var mapProp = {
    center:new google.maps.LatLng(51.508742,-0.120850),
    zoom:5,
    mapTypeId:google.maps.MapTypeId.ROADMAP
  };
  var map=new google.maps.Map(document.getElementById("googleMap"), mapProp);
}

//google.maps.event.addDomListener(window, 'load', initialize);
</script>

{% endblock %}

{% block content %}
{% comment %}
<ul>
</ul>
<br/><br/>
{% endcomment %}

To get geoloacation based information click <a href="show_map/">here</a>
</br>
</br>
Select route/direction/stop to get real time prediction (results are based on NextBus public xml feed)
</br>
</br>
Routes: <select name="route_list" id="route_list">

{% for route, route_name in routes.items %}
<option value="{{ route }}">{{ route_name }} </option>
{% endfor %}
</option>
</br>
</select>
</br>
Direction: <select name="direction_list" id="direction_list">
</select>
</br>
Stop: <select name="stop_list" id="stop_list">
</select>
<p id="prediction"></p>
</br></br>
<div id="googleMap" style="width:500px;height:380px;"></div>
{% endblock %}
